name: Test Email Notification

on:
  workflow_dispatch:
    inputs:
      recipient_email:
        description: 'Email address to send test notification to (optional - uses RECIPIENT_EMAIL secret if not provided)'
        required: false
        type: string
      test_type:
        description: 'Type of test email to send'
        required: true
        type: choice
        options:
          - new_djs_detected
          - custom_message
        default: new_djs_detected
      custom_subject:
        description: 'Custom email subject (only used if test_type is custom_message)'
        required: false
        type: string
      custom_message:
        description: 'Custom email message (only used if test_type is custom_message)'
        required: false
        type: string

jobs:
  send-test-email:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Make script executable
      run: chmod +x .github/scripts/send-test-email.sh
      
    - name: Send test email via Mailgun API
      env:
        MAILGUN_API_KEY: ${{ secrets.MAILGUN_API_KEY }}
        MAILGUN_DOMAIN: ${{ secrets.MAILGUN_DOMAIN }}
        RECIPIENT_EMAIL: ${{ inputs.recipient_email || secrets.RECIPIENT_EMAIL }}
        FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        TEST_TYPE: ${{ inputs.test_type }}
        CUSTOM_SUBJECT: ${{ inputs.custom_subject }}
        CUSTOM_MESSAGE: ${{ inputs.custom_message }}
      run: .github/scripts/send-test-email.sh

    - name: Summary
      if: success()
      run: |
        echo "## ✅ Test Email Sent Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Recipient:** ${{ inputs.recipient_email || secrets.RECIPIENT_EMAIL }}" >> $GITHUB_STEP_SUMMARY
        echo "**Test Type:** ${{ inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check your email inbox for the test notification!" >> $GITHUB_STEP_SUMMARY

    - name: Failure Summary
      if: failure()
      run: |
        echo "## ❌ Test Email Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The test email could not be sent. Please check:" >> $GITHUB_STEP_SUMMARY
        echo "- MAILGUN_API_KEY secret is set correctly" >> $GITHUB_STEP_SUMMARY
        echo "- MAILGUN_DOMAIN secret is set correctly" >> $GITHUB_STEP_SUMMARY
        echo "- RECIPIENT_EMAIL secret or input is valid" >> $GITHUB_STEP_SUMMARY
        echo "- FROM_EMAIL secret is set correctly" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the workflow logs above for detailed error messages." >> $GITHUB_STEP_SUMMARY
