name: Update README with Campaign Status

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Fetch campaign data from deployed app
      id: fetch_campaigns
      run: |
        # Get the public IP of the Azure Container Instance
        CONTAINER_IP=$(az container show \
          --resource-group inflyte-monitor-rg \
          --name inflyte-monitor \
          --query ipAddress.ip \
          --output tsv 2>/dev/null || echo "")
        
        if [ -z "$CONTAINER_IP" ]; then
          echo "Could not get container IP, using fallback data"
          echo "status=unavailable" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Fetch campaign data from the HTTP endpoint
        RESPONSE=$(curl -s --connect-timeout 10 "http://${CONTAINER_IP}:8080/campaigns" || echo "{}")
        
        if [ -z "$RESPONSE" ] || [ "$RESPONSE" = "{}" ]; then
          echo "Could not fetch campaign data"
          echo "status=unavailable" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Save the response for processing
        echo "$RESPONSE" > campaigns.json
        echo "status=available" >> $GITHUB_OUTPUT
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Update README with campaign status
      if: steps.fetch_campaigns.outputs.status == 'available'
      run: |
        chmod +x .github/scripts/update_readme.py
        python3 .github/scripts/update_readme.py

    - name: Commit and push if changed
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add README.md
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update README with current campaign status [skip ci]" && git push)
